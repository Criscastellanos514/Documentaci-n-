using System;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;

namespace ManageAdmin.GraphQL.Infrastructure.Background
{
    public class BackgroundTaskQueue : IBackgroundTaskQueue
    {
        private readonly Channel<Func<CancellationToken, Task>> _queue;

        public BackgroundTaskQueue()
        {
            _queue = Channel.CreateUnbounded<Func<CancellationToken, Task>>();
        }

        public void QueueBackgroundWorkItem(Func<CancellationToken, Task> workItem)
        {
            if (workItem == null)
                throw new ArgumentNullException(nameof(workItem));

            _queue.Writer.TryWrite(workItem);
        }

        public async Task<Func<CancellationToken, Task>> DequeueAsync(
            CancellationToken cancellationToken)
        {
            return await _queue.Reader.ReadAsync(cancellationToken);
        }
    }
}

using System;
using System.Threading;
using System.Threading.Tasks;

namespace ManageAdmin.GraphQL.Infrastructure.Background
{
    public interface IBackgroundTaskQueue
    {
        void QueueBackgroundWorkItem(Func<CancellationToken, Task> workItem);

        Task<Func<CancellationToken, Task>> DequeueAsync(
            CancellationToken cancellationToken);
    }
}


using System;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;

namespace ManageAdmin.GraphQL.Infrastructure.Background
{
    public class BackgroundTaskQueue : IBackgroundTaskQueue
    {
        private readonly Channel<Func<CancellationToken, Task>> _queue;

        public BackgroundTaskQueue()
        {
            _queue = Channel.CreateUnbounded<Func<CancellationToken, Task>>();
        }

        public void QueueBackgroundWorkItem(Func<CancellationToken, Task> workItem)
        {
            if (workItem == null)
                throw new ArgumentNullException(nameof(workItem));

            _queue.Writer.TryWrite(workItem);
        }

        public async Task<Func<CancellationToken, Task>> DequeueAsync(
            CancellationToken cancellationToken)
        {
            return await _queue.Reader.ReadAsync(cancellationToken);
        }
    }
}


using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using System;
using System.Threading;
using System.Threading.Tasks;

namespace ManageAdmin.GraphQL.Infrastructure.Background
{
    public class QueuedHostedService : BackgroundService
    {
        private readonly ILogger<QueuedHostedService> _logger;
        private readonly IBackgroundTaskQueue _taskQueue;
        private readonly IServiceScopeFactory _scopeFactory;

        public QueuedHostedService(
            IBackgroundTaskQueue taskQueue,
            IServiceScopeFactory scopeFactory,
            ILogger<QueuedHostedService> logger)
        {
            _taskQueue = taskQueue;
            _scopeFactory = scopeFactory;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("QueuedHostedService iniciado.");

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    // Espera hasta que haya un item en cola
                    var workItem = await _taskQueue.DequeueAsync(stoppingToken);

                    // Creamos un scope por tarea (IMPORTANTE para usar DB / Services sin romper DI)
                    using var scope = _scopeFactory.CreateScope();

                    // Ejecutamos la tarea
                    await workItem(stoppingToken);
                }
                catch (OperationCanceledException)
                {
                    // cierre normal
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error ejecutando tarea en background.");
                }
            }

            _logger.LogInformation("QueuedHostedService detenido.");
        }
    }
}

builder.Services.AddSingleton<IBackgroundTaskQueue, BackgroundTaskQueue>();
builder.Services.AddHostedService<QueuedHostedService>();

using ManageAdmin.GraphQL.Infrastructure.Background;private readonly DataBase dataBase;
private readonly RequestQueryBuilder queryBuilder;
private readonly IBackgroundTaskQueue taskQueue; i√≥

public RequestServices(
    DataBase dataBase,
    RequestQueryBuilder queryBuilder,
    IBackgroundTaskQueue taskQueue)
{
    this.dataBase = dataBase;
    this.queryBuilder = queryBuilder;
    this.taskQueue = taskQueue;
}

var success = exec > 0;

if (success)
{
    taskQueue.QueueBackgroundWorkItem(async token =>
    {
        try
        {
            // Simulaci√≥n de proceso largo
            await Task.Delay(2000, token);

            Console.WriteLine($"Procesando request {request.request_id}");

            // üî• AQU√ç puedes poner:
            // - Enviar correo
            // - Crear approval autom√°tico
            // - Generar tareas
            // - Validar reglas
            // - Llamar otro servicio
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en background: {ex.Message}");
        }
    });
}

return success;