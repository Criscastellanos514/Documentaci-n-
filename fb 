USE control_inventario_ti;
GO

SELECT state_id, state_name
FROM dbo.states
ORDER BY state_name;

SELECT TOP 1 entity_id
FROM dbo.entities
WHERE entity_name = 'Request Approval';

SELECT TOP 1 state_id
FROM dbo.states
WHERE state_name = 'Pendiente';

SELECT TOP 1 state_entity_id
FROM dbo.state_entities;


SELECT *
FROM request_approvals
WHERE request_id = (
    SELECT request_id
    FROM requests
    WHERE request_name = 'Prueba_worker_001'
);


SELECT 
  ra.request_approval_id,
  ra.request_id,
  ra.user_id,
  ra.state_entity_id,
  s.state_name,
  e.entity_name,
  ra.request_approval_type,
  ra.create_at,
  ra.modify_at
FROM dbo.request_approvals ra
JOIN dbo.state_entities se ON se.state_entity_id = ra.state_entity_id
JOIN dbo.states s ON s.state_id = se.state_id
JOIN dbo.entities e ON e.entity_id = se.entity_id
WHERE ra.request_id = (
  SELECT request_id
  FROM dbo.requests
  WHERE request_name = 'Prueba_worker_001'
);

SELECT TOP 1
  se.state_entity_id,
  s.state_name,
  e.entity_name
FROM dbo.state_entities se
JOIN dbo.states s ON s.state_id = se.state_id
JOIN dbo.entities e ON e.entity_id = se.entity_id
WHERE e.entity_name = 'Request Approval'
  AND s.state_name = 'Pendiente';



  USE control_inventario_ti;
GO

DECLARE @RequestName NVARCHAR(200) = 'Prueba_worker_001';
DECLARE @NewStateName NVARCHAR(100) = N'En revisión';

DECLARE @RequestId UNIQUEIDENTIFIER;
DECLARE @EntityId UNIQUEIDENTIFIER;
DECLARE @StateId UNIQUEIDENTIFIER;
DECLARE @NewStateEntityId UNIQUEIDENTIFIER;

-- 1) RequestId
SELECT TOP 1 @RequestId = request_id
FROM dbo.requests
WHERE request_name = @RequestName;

-- 2) EntityId de "Request Approval"
SELECT TOP 1 @EntityId = entity_id
FROM dbo.entities
WHERE entity_name = 'Request Approval';

-- 3) StateId del nuevo estado
SELECT TOP 1 @StateId = state_id
FROM dbo.states
WHERE state_name = @NewStateName;

-- 4) StateEntityId (Entity + State)
SELECT TOP 1 @NewStateEntityId = state_entity_id
FROM dbo.state_entities
WHERE entity_id = @EntityId
  AND state_id  = @StateId;

-- Validaciones (por si algo no existe)
IF @RequestId IS NULL
BEGIN
    RAISERROR('No existe la request con ese nombre.', 16, 1);
    RETURN;
END

IF @EntityId IS NULL
BEGIN
    RAISERROR('No existe entity_name = Request Approval en dbo.entities.', 16, 1);
    RETURN;
END

IF @StateId IS NULL
BEGIN
    RAISERROR('No existe state_name = En revisión en dbo.states.', 16, 1);
    RETURN;
END

IF @NewStateEntityId IS NULL
BEGIN
    RAISERROR('No existe la combinación (Request Approval + En revisión) en dbo.state_entities.', 16, 1);
    RETURN;
END

-- Ver ANTES
SELECT 'ANTES' AS momento, ra.request_approval_id, ra.request_id, ra.user_id, ra.state_entity_id, ra.modify_at
FROM dbo.request_approvals ra
WHERE ra.request_id = @RequestId;

BEGIN TRAN;

    -- Actualizar request_approvals
    UPDATE dbo.request_approvals
    SET state_entity_id = @NewStateEntityId,
        modify_at = SYSUTCDATETIME()
    WHERE request_id = @RequestId;

    SELECT @@ROWCOUNT AS FilasAfectadas_request_approvals;

    -- (Opcional) reflejarlo en requests también
    UPDATE dbo.requests
    SET request_state_description = @NewStateName
    WHERE request_id = @RequestId;

    SELECT @@ROWCOUNT AS FilasAfectadas_requests;

COMMIT;

-- Ver DESPUÉS (con join para ver el nombre del estado)
SELECT
    'DESPUES' AS momento,
    ra.request_approval_id,
    ra.request_id,
    ra.user_id,
    ra.state_entity_id,
    s.state_name,
    e.entity_name,
    ra.modify_at
FROM dbo.request_approvals ra
JOIN dbo.state_entities se ON se.state_entity_id = ra.state_entity_id
JOIN dbo.states s ON s.state_id = se.state_id
JOIN dbo.entities e ON e.entity_id = se.entity_id
WHERE ra.request_id = @RequestId;p


SELECT
    r.request_name,
    s.state_name
FROM dbo.requests r
JOIN dbo.request_approvals ra ON ra.request_id = r.request_id
JOIN dbo.state_entities se ON se.state_entity_id = ra.state_entity_id
JOIN dbo.states s ON s.state_id = se.state_id
WHERE r.request_name = 'Prueba_worker_001';


SELECT r.request_name, s.state_name
FROM dbo.requests r
JOIN dbo.request_approvals ra ON ra.request_id = r.request_id
JOIN dbo.state_entities se ON se.state_entity_id = ra.state_entity_id
JOIN dbo.states s ON s.state_id = se.state_id
WHERE r.request_name = 'NombreQueCreaste';