{
  "ConnectionStrings": {
    "Default": "Server=TU_SERVIDOR;Database=control_inventario_ti;User Id=TU_USER;Password=TU_PASSWORD;TrustServerCertificate=True;"
  }
}



using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Configuration;

namespace RequestApprovalWorker.Data;

public class SqlConnectionFactory
{
    private readonly string _connStr;

    public SqlConnectionFactory(IConfiguration config)
    {
        _connStr = config.GetConnectionString("Default")
                  ?? throw new Exception("No existe ConnectionStrings:Default en appsettings.json");
    }

    public SqlConnection Create() => new SqlConnection(_connStr);
}



using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using RequestApprovalWorker.Data;
using RequestApprovalWorker.Services;
using Dapper;

var host = Host.CreateDefaultBuilder(args)
    .ConfigureAppConfiguration((context, config) =>
    {
        config.AddJsonFile("appsettings.json", optional: false, reloadOnChange: true);
    })
    .ConfigureServices(services =>
    {
        services.AddSingleton<SqlConnectionFactory>();
        services.AddSingleton<RequestApprovalService>();
    })
    .Build();

using var scope = host.Services.CreateScope();
var approvalService = scope.ServiceProvider.GetRequiredService<RequestApprovalService>();
var factory = scope.ServiceProvider.GetRequiredService<SqlConnectionFactory>();

// 1) Tomar un request "Pendiente" (de tu DB)
using (var conn = factory.Create())
{
    await conn.OpenAsync();

    // OJO: esto asume que request_state_description = 'Pendiente'
    // Si tu campo usa otra cosa, me lo decís y lo ajusto.
    var req = await conn.QueryFirstOrDefaultAsync<(Guid request_id, Guid user_id)>(@"
SELECT TOP 1 request_id, user_id
FROM requests
WHERE request_state_description = 'Pendiente'
ORDER BY create_at DESC
");

    if (req.request_id == Guid.Empty)
    {
        Console.WriteLine("No encontré requests con request_state_description = 'Pendiente'.");
        return;
    }

    Console.WriteLine($"Probando con Request: {req.request_id} | User: {req.user_id}");

    // 2) Insertar approval automático para ese request
    await approvalService.InsertApprovalForRequestAsync(req.request_id, req.user_id);
}

Console.WriteLine("Listo. Presiona ENTER para salir.");
Console.ReadLine();


using System.Data;
using System.Data.SqlClient;
using Microsoft.Extensions.Configuration;

namespace RequestApprovalWorker.Data;

public class SqlConnectionFactory
{
    private readonly IConfiguration _config;

    public SqlConnectionFactory(IConfiguration config)
    {
        _config = config;
    }

    public IDbConnection Create()
    {
        var cs = _config.GetConnectionString("DefaultConnection");
        return new SqlConnection(cs);
    }
}


using Dapper;
using System.Data;
using RequestApprovalWorker.Data;

namespace RequestApprovalWorker.Services;

public class RequestApprovalService
{
    private readonly SqlConnectionFactory _factory;

    public RequestApprovalService(SqlConnectionFactory factory)
    {
        _factory = factory;
    }

    public async Task InsertApprovalForRequestAsync(Guid requestId, Guid userId)
    {
        using var conn = _factory.Create();
        conn.Open();

        // 1) entity_id de 'Request Approval'
        var entityId = await conn.QueryFirstAsync<Guid>(@"
SELECT TOP 1 entity_id
FROM entities
WHERE entity_name = 'Request Approval'");

        // 2) state_id de 'Pendiente'
        var stateId = await conn.QueryFirstAsync<Guid>(@"
SELECT TOP 1 state_id
FROM states
WHERE state_name = 'Pendiente'");

        // 3) state_entity_id (Pendiente + Request Approval)
        var stateEntityId = await conn.QueryFirstAsync<Guid>(@"
SELECT TOP 1 state_entity_id
FROM state_entities
WHERE entity_id = @entityId AND state_id = @stateId",
            new { entityId, stateId });

        // 4) Insert en request_approvals
        await conn.ExecuteAsync(@"
INSERT INTO request_approvals
(
    request_approval_id,
    request_id,
    user_id,
    state_entity_id,
    request_approval_type,
    approval_date,
    create_at,
    modify_at
)
VALUES
(
    NEWID(),
    @requestId,
    @userId,
    @stateEntityId,
    'AUTO',
    GETDATE(),
    GETDATE(),
    GETDATE()
)",
        new { requestId, userId, stateEntityId });
    }
}


using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using RequestApprovalWorker.Data;
using RequestApprovalWorker.Services;
using Dapper;

var host = Host.CreateDefaultBuilder(args)
    .ConfigureAppConfiguration((context, config) =>
    {
        config.AddJsonFile("appsettings.json", optional: false, reloadOnChange: true);
    })
    .ConfigureServices(services =>
    {
        services.AddSingleton<SqlConnectionFactory>();
        services.AddSingleton<RequestApprovalService>();
    })
    .Build();

using var scope = host.Services.CreateScope();
var approvalService = scope.ServiceProvider.GetRequiredService<RequestApprovalService>();
var factory = scope.ServiceProvider.GetRequiredService<SqlConnectionFactory>();

using (var conn = factory.Create())
{
    conn.Open();

    // Busca el último request que esté en “Pendiente”
    // (si tu columna se llama diferente, ajustamos aquí)
    var req = await conn.QueryFirstOrDefaultAsync<(Guid request_id, Guid user_id)>(@"
SELECT TOP 1 request_id, user_id
FROM requests
WHERE request_state_description = 'Pendiente'
ORDER BY create_at DESC");

    if (req.request_id == Guid.Empty)
    {
        Console.WriteLine("No encontré requests en estado 'Pendiente'.");
        return;
    }

    Console.WriteLine($"Probando con Request: {req.request_id} | User: {req.user_id}");

    await approvalService.InsertApprovalForRequestAsync(req.request_id, req.user_id);

    Console.WriteLine("✅ Approval automático insertado en request_approvals.");
}

Console.WriteLine("Listo.");

dotnet add package Dapper
dotnet add package Microsoft.Data.SqlClient


using System;
using System.Threading.Tasks;
using Dapper;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using RequestApprovalWorker.Data;
using RequestApprovalWorker.Services;

namespace RequestApprovalWorker
{
    internal class Program
    {
        public static async Task Main(string[] args)
        {
            var host = Host.CreateDefaultBuilder(args)
                .ConfigureAppConfiguration((context, config) =>
                {
                    config.AddJsonFile("Config/appsettings.json", optional: false, reloadOnChange: true);
                })
                .ConfigureServices(services =>
                {
                    services.AddSingleton<SqlConnectionFactory>();
                    services.AddSingleton<RequestApprovalService>();
                })
                .Build();

            using var scope = host.Services.CreateScope();
            var approvalService = scope.ServiceProvider.GetRequiredService<RequestApprovalService>();
            var factory = scope.ServiceProvider.GetRequiredService<SqlConnectionFactory>();

            using var conn = factory.Create();
            conn.Open();

            // Busca el último request que esté en "Pendiente"
            // Si tu columna se llama distinto, cámbiala aquí:
            var req = await conn.QueryFirstOrDefaultAsync<(Guid request_id, Guid user_id)>(@"
                SELECT TOP 1 request_id, user_id
                FROM requests
                WHERE request_state_description = 'Pendiente'
                ORDER BY create_at DESC
            ");

            if (req.request_id == Guid.Empty)
            {
                Console.WriteLine("No encontré requests en estado 'Pendiente'.");
                return;
            }

            Console.WriteLine($"Probando con Request: {req.request_id} | User: {req.user_id}");

            await approvalService.InsertApprovalForRequestAsync(req.request_id, req.user_id);

            Console.WriteLine("✅ Approval automático insertado en request_approvals.");
            Console.WriteLine("Listo.");
        }
    }
}

"DefaultConnection": "Server=localhost;Database=TU_DB;Trusted_Connection=True;TrustServerCertificate=True;"


{
  "ConnectionStrings": {
    "Default": "Server=localhost;Database=TU_BASE_DE_DATOS;Trusted_Connection=True;TrustServerCertificate=True;"
  },
  "Worker": {
    "IntervalSeconds": 10,
    "DryRun": false
  }
}


dotnet add package Dapper
dotnet add package Microsoft.Data.SqlClient
dotnet add package Microsoft.Extensions.Configuration.Json


"ConnectionStrings": {
  "Default": "Server=.;Database=TU_BASE_DE_DATOS;Trusted_Connection=True;TrustServerCertificate=True;"
}
