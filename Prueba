Install-Package Dapper
Install-Package Microsoft.Data.SqlClient
Install-Package Microsoft.Extensions.Configuration.Json

using System.Data;
using Microsoft.Data.SqlClient;
using Microsoft.Extensions.Configuration;

namespace PruebaWorker.Data
{
    public class SqlConnectionFactory
    {
        private readonly IConfiguration _config;

        public SqlConnectionFactory(IConfiguration config)
        {
            _config = config;
        }

        public IDbConnection Create()
        {
            var cs = _config.GetConnectionString("Default");
            return new SqlConnection(cs);
        }
    }
}


using System;
using System.Threading.Tasks;
using Dapper;
using PruebaWorker.Data;

namespace PruebaWorker.Services
{
    public class RequestApprovalService
    {
        private readonly SqlConnectionFactory _factory;

        public RequestApprovalService(SqlConnectionFactory factory)
        {
            _factory = factory;
        }

        public async Task InsertApprovalForRequestAsync(Guid requestId, Guid userId)
        {
            using var conn = _factory.Create();
            conn.Open();

            // 1) entity_id de 'Request Approval'
            var entityId = await conn.QueryFirstAsync<Guid>(@"
SELECT TOP 1 entity_id
FROM entities
WHERE entity_name = 'Request Approval'");

            // 2) state_id de 'Pendiente'
            var stateId = await conn.QueryFirstAsync<Guid>(@"
SELECT TOP 1 state_id
FROM states
WHERE state_name = 'Pendiente'");

            // 3) state_entity_id (Pendiente + Request Approval)
            var stateEntityId = await conn.QueryFirstAsync<Guid>(@"
SELECT TOP 1 state_entity_id
FROM state_entities
WHERE entity_id = @entityId AND state_id = @stateId",
                new { entityId, stateId });

            // 4) Insert en request_approvals
            await conn.ExecuteAsync(@"
INSERT INTO request_approvals
(
    request_approval_id,
    request_id,
    user_id,
    state_entity_id,
    request_approval_type,
    approval_date
)
VALUES
(
    NEWID(),
    @requestId,
    @userId,
    @stateEntityId,
    'Automatico',
    GETDATE()
)",
                new { requestId, userId, stateEntityId });
        }
    }
}


using System;
using System.Threading;
using System.Threading.Tasks;
using Dapper;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using PruebaWorker.Data;
using PruebaWorker.Services;

namespace PruebaWorker
{
    public class Worker : BackgroundService
    {
        private readonly ILogger<Worker> _logger;
        private readonly IConfiguration _config;
        private readonly SqlConnectionFactory _factory;
        private readonly RequestApprovalService _approvalService;

        public Worker(
            ILogger<Worker> logger,
            IConfiguration config,
            SqlConnectionFactory factory,
            RequestApprovalService approvalService)
        {
            _logger = logger;
            _config = config;
            _factory = factory;
            _approvalService = approvalService;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            var seconds = _config.GetValue<int>("Worker:IntervalSeconds");
            var dryRun = _config.GetValue<bool>("Worker:DryRun");

            _logger.LogInformation("Worker iniciado. IntervalSeconds={seconds}, DryRun={dryRun}", seconds, dryRun);

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    using var conn = _factory.Create();
                    conn.Open();

                    // Busca el último request "Pendiente"
                    var req = await conn.QueryFirstOrDefaultAsync<(Guid request_id, Guid user_id)>(@"
SELECT TOP 1 request_id, user_id
FROM requests
WHERE request_state_description = 'Pendiente'
ORDER BY create_at DESC");

                    if (req.request_id != Guid.Empty)
                    {
                        _logger.LogInformation("Encontré request={requestId} user={userId}", req.request_id, req.user_id);

                        if (!dryRun)
                        {
                            await _approvalService.InsertApprovalForRequestAsync(req.request_id, req.user_id);
                            _logger.LogInformation("Approval insertado OK.");
                        }
                        else
                        {
                            _logger.LogInformation("DryRun=true, no inserté nada.");
                        }
                    }
                    else
                    {
                        _logger.LogInformation("No hay requests pendientes.");
                    }
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error en el Worker");
                }

                await Task.Delay(TimeSpan.FromSeconds(seconds), stoppingToken);
            }
        }
    }
}


using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using PruebaWorker;
using PruebaWorker.Data;
using PruebaWorker.Services;

IHost host = Host.CreateDefaultBuilder(args)
    .ConfigureServices(services =>
    {
        services.AddSingleton<SqlConnectionFactory>();
        services.AddSingleton<RequestApprovalService>();
        services.AddHostedService<Worker>();
    })
    .Build();

await host.RunAsync();


{
  "ConnectionStrings": {
    "Default": "Server=TU_SERVIDOR;Database=TU_DB;User Id=TU_USER;Password=TU_PASS;TrustServerCertificate=True;"
  },
  "Worker": {
    "IntervalSeconds": 10,
    "DryRun": false
  }
}