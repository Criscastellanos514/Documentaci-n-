{
  "RequestApprovalId": "CC40FCCC-CC57-42A5-BD55-0E7DFB8FC350",
  "RequestId": "55582C38-7ED7-4830-8509-D708B7F1C50A",
  "UserId": "930D10FC-8C14-460F-9C5E-D15B2049E570",
  "StateEntityId": "64C7A141-B592-402A-8099-CE21430E00A2",
  "RequestApprovalType": "Aprobación Automática",
  "ApprovalDate": null,
  "CreatedAt": "2026-02-18T16:30:00Z",
  "ModifyAt": null
}

SELECT TOP 5 *
FROM control_inventario_til.dbo.request_approvals
WHERE approval_date IS NULL
ORDER BY create_at DESC;

{
  "RequestId": "PEGA_EL_request_id_QUE_SALIO",
  "UserId": "PEGA_EL_user_id_CORRESPONDIENTE"
}

SELECT request_id, state_entity_id, approval_date
FROM control_inventario_til.dbo.request_approvals
WHERE approval_date IS NULL;


{
  "RequestId": "55582C3B-7ED7-4830-8509-D708B7F1C50A",
  "UserId": "930D10FC-8C14-460F-9C5E-D15B2049E570"
}


SELECT DISTINCT state_entity_id
FROM control_inventario_til.dbo.request_approvals
WHERE approval_date IS NULL;

SELECT TOP 10
    request_id,
    user_id,
    state_entity_id,
    approval_date,
    create_at
FROM control_inventario_til.dbo.request_approvals
WHERE state_entity_id = '1701686C-649B-4560-AC69-D307D5E7F728'
ORDER BY create_at DESC;


SELECT
  state_entity_id,
  COUNT(*) AS total
FROM control_inventario_til.dbo.request_approvals
GROUP BY state_entity_id
ORDER BY total DESC;


SELECT
  state_entity_id,
  COUNT(*) AS pendientes_por_fecha
FROM control_inventario_til.dbo.request_approvals
WHERE approval_date IS NULL
GROUP BY state_entity_id
ORDER BY pendientes_por_fecha DESC;


SELECT TOP 1
    request_id AS RequestId,
    user_id AS UserId
FROM control_inventario_til.dbo.request_approvals
WHERE state_entity_id = 'A21A759F-CB89-44FE-A54D-E31B6178E68F'
FOR JSON PATH, WITHOUT_ARRAY_WRAPPER;


SELECT TOP (10) request_id, user_id
FROM control_inventario_til.dbo.request_approvals
WHERE state_entity_id = 'A21A759F-CB89-44FE-A54D-E31B6178E68F'
ORDER BY create_at ASC;

SELECT request_id, state_entity_id, approval_date
FROM control_inventario_til.dbo.request_approvals
WHERE state_entity_id = 'A21A759F-CB89-44FE-A54D-E31B6178E68F';


SELECT TOP (10)
    r.request_id      AS RequestId,
    r.user_id         AS UserId,
    r.state_entity_id AS StateEntityId,
    r.create_at       AS CreateAt
FROM control_inventario_ti.dbo.requests r
WHERE r.state_entity_id = 'A21A759F-CB89-44FE-A54D-E31B6178E68F'
  AND r.request_enabled = 1
ORDER BY r.create_at ASC;



const string sql = @"
SELECT TOP (@BatchSize)
    r.request_id      AS RequestId,
    r.user_id         AS UserId,
    r.state_entity_id AS StateEntityId,
    r.create_at       AS CreateAt
FROM dbo.requests r
WHERE r.state_entity_id = @EstadoPendiente
  AND r.request_enabled = 1
ORDER BY r.create_at ASC;
";


SELECT TOP (@BatchSize)
    r.request_id        AS RequestId,
    r.user_id           AS UserId,
    r.state_entity_id   AS StateEntityId,
    r.create_at         AS CreateAt
FROM dbo.request_approvals r
WHERE r.state_entity_id = @EstadoPendiente
ORDER BY r.create_at ASC
ORDER



SELECT COUNT(1)
FROM dbo.request_approvals
WHERE request_id      = @RequestId
  AND state_entity_id = @EstadoPendiente



UPDATE dbo.request_approvals
SET state_entity_id = @EstadoEnRevision,
    modify_at       = @ModifyAt
WHERE request_id = @RequestId



SELECT 
    se.state_entity_id,
    s.state_name,
    e.entity_name
FROM dbo.state_entities se
JOIN dbo.states s   ON s.state_id = se.state_id
JOIN dbo.entities e ON e.entity_id = se.entity_id
WHERE se.state_entity_id IN (
'F27EF7A8-793B-4237-AA99-20E39A51D785',
'1B993444-0E62-4414-9E37-62030A154761',
'1701686C-649B-4560-BC69-D307D5E7F728'
);


public async Task<IEnumerable<PendingRequest>> GetPendientesAsync()
{
    const string sql = """
        SELECT TOP (@BatchSize)
            r.request_id AS RequestId,
            r.user_id AS UserId,
            r.state_entity_id AS StateEntityId,
            r.create_at AS CreateAt
        FROM dbo.requests r
        WHERE r.state_entity_id = @EstadoPendiente
          AND r.request_enabled = 1
        ORDER BY r.create_at ASC
    """;

    using var connection = _connectionFactory.CreateConnection();

    var results = await connection.QueryAsync<PendingRequest>(sql, new
    {
        BatchSize = _batchSize,
        EstadoPendiente = _estadoPendiente
    });

    _logger.LogInformation("Requests pendientes encontradas: {Count}", results.Count());
    return results;
}