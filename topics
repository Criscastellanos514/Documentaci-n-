using System;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;

namespace ManageAdmin.GraphQL.Infrastructure.Background
{
    public class BackgroundTaskQueue : IBackgroundTaskQueue
    {
        private readonly Channel<Func<CancellationToken, Task>> _queue;

        public BackgroundTaskQueue()
        {
            _queue = Channel.CreateUnbounded<Func<CancellationToken, Task>>();
        }

        public void QueueBackgroundWorkItem(Func<CancellationToken, Task> workItem)
        {
            if (workItem == null)
                throw new ArgumentNullException(nameof(workItem));

            _queue.Writer.TryWrite(workItem);
        }

        public async Task<Func<CancellationToken, Task>> DequeueAsync(
            CancellationToken cancellationToken)
        {
            return await _queue.Reader.ReadAsync(cancellationToken);
        }
    }
}

using System;
using System.Threading;
using System.Threading.Tasks;

namespace ManageAdmin.GraphQL.Infrastructure.Background
{
    public interface IBackgroundTaskQueue
    {
        void QueueBackgroundWorkItem(Func<CancellationToken, Task> workItem);

        Task<Func<CancellationToken, Task>> DequeueAsync(
            CancellationToken cancellationToken);
    }
}


using System;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;

namespace ManageAdmin.GraphQL.Infrastructure.Background
{
    public class BackgroundTaskQueue : IBackgroundTaskQueue
    {
        private readonly Channel<Func<CancellationToken, Task>> _queue;

        public BackgroundTaskQueue()
        {
            _queue = Channel.CreateUnbounded<Func<CancellationToken, Task>>();
        }

        public void QueueBackgroundWorkItem(Func<CancellationToken, Task> workItem)
        {
            if (workItem == null)
                throw new ArgumentNullException(nameof(workItem));

            _queue.Writer.TryWrite(workItem);
        }

        public async Task<Func<CancellationToken, Task>> DequeueAsync(
            CancellationToken cancellationToken)
        {
            return await _queue.Reader.ReadAsync(cancellationToken);
        }
    }
}


using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using System;
using System.Threading;
using System.Threading.Tasks;

namespace ManageAdmin.GraphQL.Infrastructure.Background
{
    public class QueuedHostedService : BackgroundService
    {
        private readonly ILogger<QueuedHostedService> _logger;
        private readonly IBackgroundTaskQueue _taskQueue;
        private readonly IServiceScopeFactory _scopeFactory;

        public QueuedHostedService(
            IBackgroundTaskQueue taskQueue,
            IServiceScopeFactory scopeFactory,
            ILogger<QueuedHostedService> logger)
        {
            _taskQueue = taskQueue;
            _scopeFactory = scopeFactory;
            _logger = logger;
        }

        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            _logger.LogInformation("QueuedHostedService iniciado.");

            while (!stoppingToken.IsCancellationRequested)
            {
                try
                {
                    // Espera hasta que haya un item en cola
                    var workItem = await _taskQueue.DequeueAsync(stoppingToken);

                    // Creamos un scope por tarea (IMPORTANTE para usar DB / Services sin romper DI)
                    using var scope = _scopeFactory.CreateScope();

                    // Ejecutamos la tarea
                    await workItem(stoppingToken);
                }
                catch (OperationCanceledException)
                {
                    // cierre normal
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Error ejecutando tarea en background.");
                }
            }

            _logger.LogInformation("QueuedHostedService detenido.");
        }
    }
}

builder.Services.AddSingleton<IBackgroundTaskQueue, BackgroundTaskQueue>();
builder.Services.AddHostedService<QueuedHostedService>();

using ManageAdmin.GraphQL.Infrastructure.Background;private readonly DataBase dataBase;
private readonly RequestQueryBuilder queryBuilder;
private readonly IBackgroundTaskQueue taskQueue; i√≥

public RequestServices(
    DataBase dataBase,
    RequestQueryBuilder queryBuilder,
    IBackgroundTaskQueue taskQueue)
{
    this.dataBase = dataBase;
    this.queryBuilder = queryBuilder;
    this.taskQueue = taskQueue;
}

var success = exec > 0;

if (success)
{
    taskQueue.QueueBackgroundWorkItem(async token =>
    {
        try
        {
            // Simulaci√≥n de proceso largo
            await Task.Delay(2000, token);

            Console.WriteLine($"Procesando request {request.request_id}");

            // üî• AQU√ç puedes poner:
            // - Enviar correo
            // - Crear approval autom√°tico
            // - Generar tareas
            // - Validar reglas
            // - Llamar otro servicio
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en background: {ex.Message}");
        }
    });
}

return success;

var success = exec > 0;

if (success)
{
    Console.WriteLine($"‚úÖ INSERT OK -> Encolando request {request.request_id}");

    taskQueue.QueueBackgroundWorkItem(async token =>
    {
        Console.WriteLine($"üî• BACKGROUND INICIADO -> request {request.request_id}");

        try
        {
            await Task.Delay(2000, token);
            Console.WriteLine($"‚úÖ Procesando request {request.request_id}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error en background: {ex.Message}");
        }
    });
}

return success;


if (success)
{
    taskQueue.QueueBackgroundWorkItem(async token =>
    {
        try
        {
            // 1) entity_id de "Request Approval"
            var entityId = await dataBase.Connection.QueryFirstAsync<Guid>(@"
                SELECT TOP 1 entity_id
                FROM entities
                WHERE entity_name = 'Request Approval'
            ");

            // 2) state_id de "Pendiente"
            var stateId = await dataBase.Connection.QueryFirstAsync<Guid>(@"
                SELECT TOP 1 state_id
                FROM states
                WHERE state_name = 'Pendiente'
            ");

            // 3) state_entity_id (Pendiente + Request Approval)
            var stateEntityId = await dataBase.Connection.QueryFirstAsync<Guid>(@"
                SELECT TOP 1 state_entity_id
                FROM state_entities
                WHERE entity_id = @entityId AND state_id = @stateId
            ", new { entityId, stateId });

            // 4) Insert autom√°tico en request_approvals
            await dataBase.Connection.ExecuteAsync(@"
                INSERT INTO request_approvals
                (
                    request_approval_id,
                    request_id,
                    user_id,
                    state_entity_id,
                    request_approval_type,
                    approval_date,
                    create_at,
                    modify_at
                )
                VALUES
                (
                    @request_approval_id,
                    @request_id,
                    @user_id,
                    @state_entity_id,
                    @request_approval_type,
                    @approval_date,
                    @create_at,
                    @modify_at
                )
            ",
            new
            {
                request_approval_id = Guid.NewGuid(),
                request_id = request.request_id,
                user_id = request.user_id,
                state_entity_id = stateEntityId,
                request_approval_type = "AUTO",
                approval_date = DateTime.UtcNow,
                create_at = DateTime.UtcNow,
                modify_at = DateTime.UtcNow
            });

            Console.WriteLine("‚úî Aprobaci√≥n autom√°tica creada (Pendiente)");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error en background approval: {ex.Message}");
        }
    });
}